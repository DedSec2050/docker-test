pipeline {
    agent any

    environment {
        DOCKER_NET = 'docker-net'
        // The following variables will be fetched automatically from Jenkins Global Properties
        // Example: set these in Jenkins UI, not in the repo:
        // MONGO_URI=mongodb+srv://...
        // SECRET_KEY=your-secret-key
        // FLASK_ENV=development
        // BACKEND_URL=....
    }

    stages {
        stage('Clean Old Containers & Images') {
            steps {
                sh '''
                    docker stop jenkins-backend-container || true
                    docker rm jenkins-backend-container || true
                    docker rmi jenkins-backend || true

                    docker stop jenkins-frontend-container || true
                    docker rm jenkins-frontend-container || true
                    docker rmi jenkins-frontend || true
                '''
            }
        }

        stage('Create Network If Missing') {
            steps {
                sh '''
                    docker network inspect $DOCKER_NET >/dev/null 2>&1 || docker network create $DOCKER_NET
                '''
            }
        }

        stage('Build Backend') {
            steps {
                dir('backend') {
                    sh 'docker build -t jenkins-backend .'
                }
            }
        }

        stage('Build Frontend') {
            steps {
                dir('frontend') {
                    sh 'docker build -t jenkins-frontend .'
                }
            }
        }

        stage('Run Backend') {
            steps {
                sh '''
                    docker run -d \
                      --name jenkins-backend-container \
                      --network $DOCKER_NET \
                      -p 8000:8000 \
                      -e MONGO_URI="$MONGO_URI" \
                      -e SECRET_KEY="$SECRET_KEY" \
                      -e FLASK_ENV="$FLASK_ENV" \
                      jenkins-backend
                '''
            }
        }

        stage('Run Frontend') {
            steps {
                sh '''
                    docker run -d \
                      --name jenkins-frontend-container \
                      --network $DOCKER_NET \
                      -p 3000:3000 \
                      -e BACKEND_URL="$BACKEND_URL" \
                      jenkins-frontend npm run dev
                '''
            }
        }
    }
}
